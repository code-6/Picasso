<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">
<head>
    <title>PCS - Tours</title>

    <link rel="stylesheet" type="text/css" th:href="@{/webjars/datatables/css/jquery.dataTables.css}">

    <link rel="stylesheet" type="text/css"
          th:href="@{/webjars/bootstrap-daterangepicker/css/bootstrap-daterangepicker.css}"/>

    <link rel="stylesheet" type="text/css"
          th:href="@{/webjars/bootstrap-select/dist/css/bootstrap-select.min.css}"/>

    <style>
        .from-to-date-fields-divider {
            padding-right: 1rem;
            padding-left: 1rem;
            text-align: center;
        }
    </style>
</head>
<body class="sb-nav-fixed">
<div layout:fragment="header">
    <nav class="sb-topnav navbar navbar-expand-sm navbar-light bg-light">
        <!-- Navbar Brand-->
        <a class="navbar-brand ps-3" th:href="@{/}">Picasso 2.0</a>
        <!-- Sidebar Toggle-->
        <button class="btn btn-link btn-sm order-1 order-lg-0 me-4 me-lg-0" id="sidebarToggle" href="#!">
            <i class="fas fa-bars"></i>
        </button>

        <!-- Page management components -->
        <div class="mx-auto order-0">
            <div class="btn-toolbar" role="toolbar" aria-label="Toolbar with button groups">
                <div class="btn-group mr-2" role="group" aria-label="First group">
                    <a class="nav-link" href="#tourCriteria"
                       data-toggle="collapse" data-target="#tourFilterDiv"
                       aria-expanded="false" aria-controls="tourFilterDiv">
                        <i class="fas fa-filter"></i>
                        <span th:text="#{filter.cap.pl}"></span>
                    </a>
                </div>
                <div class="btn-group mr-2" role="group" aria-label="Second group">
                    <a class="nav-link" id="tourFormToggleBtn" data-toggle="collapse"
                       data-target="#tourFormContainer"
                       aria-expanded="false" aria-controls="tourFormContainer" href="#tourFormContainer">
                        <i id="tourFormToggleBtnIcon" class="fas fa-eye"></i>
                        <span th:text="#{tourFormToggleBtn}"></span>
                    </a>
                </div>
            </div>
        </div>

        <form class="d-none d-md-inline-block form-inline ms-auto me-0 me-md-3 my-2 my-md-0">
            <div class="input-group">
            </div>
        </form>
        <!-- Navbar-->
        <ul class="navbar-nav ms-auto ms-md-0 me-3 me-lg-4">
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" id="navbarDropdown" href="#" role="button" data-bs-toggle="dropdown"
                   aria-expanded="false">
                    <i class="fas fa-user fa-fw"></i>
                </a>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                    <li><a class="dropdown-item" th:href="@{/logout}">Logout</a></li>
                    <li>
                        <hr class="dropdown-divider"/>
                    </li>

                </ul>
            </li>
        </ul>
    </nav>
</div>

<div layout:fragment="content">
    <!--    tour form-->
    <div class="collapse" id="tourFormContainer">
        <div class="card">
            <div class="card-header">Tour form</div>
            <div class="card-body">
                <form th:object="${tour}" th:action="@{/tour}" th:method="post" id="tourForm"
                      enctype="multipart/form-data">
                    <div th:include="tour/tourForm :: tourFormContent"></div>
                </form>
            </div>
        </div>
    </div>
    <!--    filter form-->
    <div class="collapse show" id="tourFilterDiv">
        <div class="card">
            <div class="card-header">Tours filter form</div>
            <div class="card-body">
                <form th:object="${tourFilter}" id="tourFilterForm">
                    <div th:include="tour/tourFilterForm :: tourFilterFormContent"></div>
                </form>
            </div>
        </div>
    </div>
    <!--    tours table -->
    <div class="collapse show">
        <div class="card">
            <div class="card-header">Tours table</div>
            <div class="card-body">
                <table id="toursTable" class="display compact cell-border hover stripe"
                       th:replace="tour/toursTable :: toursTable"></table>
            </div>
        </div>
    </div>
</div>
<div th:fragment="scripts">

    <script type="text/javascript" th:src="@{/webjars/momentjs/moment.js}"></script>

    <script type="text/javascript" charset="utf8"
            th:src="@{/webjars/datatables/js/jquery.dataTables.js}"></script>

    <script type="text/javascript" charset="utf8"
            th:src="@{/js/datetime-moment.js}"></script>

    <script type="text/javascript"
            th:src="@{/webjars/bootstrap-daterangepicker/js/bootstrap-daterangepicker.js}"></script>

    <script type="text/javascript"
            th:src="@{/webjars/bootstrap-select/dist/js/bootstrap-select.js}"></script>

    <script th:inline="javascript">
        /*<![CDATA[*/
        let mainUrl = $("meta[name='mainUrl']").attr("content");

        let userLocale = $("meta[name='userLocale']").attr('content');

        moment.locale(userLocale); // to fix different locale issue in date-range picker

        let dateRangePickerDateFormat = $("meta[name='dateRangePickerDateFormat']").attr('content');
        let ganttTaskDateFormat = $("meta[name='ganttTaskDateFormat']").attr('content');
        let ganttMajorDateFormat = $("meta[name='ganttMajorDateFormat']").attr('content');


        // change tourFormToggleBtn icon on toggle
        let tourFormContainer = $('#tourFormContainer');
        let tourFormToggleBtnIcon = $('#tourFormToggleBtnIcon');
        let tourForm = $('#tourForm');

        $(tourFormContainer).on('shown.bs.collapse', function (e) {
            $(tourFormToggleBtnIcon).removeClass('fa-eye')
            $(tourFormToggleBtnIcon).addClass('fa-eye-slash')
        })

        $(tourFormContainer).on('hidden.bs.collapse', function (e) {
            $(tourFormToggleBtnIcon).removeClass('fa-eye-slash')
            $(tourFormToggleBtnIcon).addClass('fa-eye')
        })

        $(document).ready(function () {

            initDataTable();

            initSingleDatePickers();

            initTourFormButtons();

            initEditTourButtons();
        });

        function initDataTable() {
            $.fn.dataTable.moment(dateRangePickerDateFormat, userLocale); // to fix sort by date columns
            $('#toursTable').DataTable({
                paging: true,
                searching: true,
                ordering: true,
                fixedHeader: true,
                columnDefs: [
                    {
                        targets: 4,
                        render: function (data, type, row) {
                            return data.length > 80 ?
                                data.substr(0, 80) + '…' :
                                data;
                        }
                    }
                ]
            });
        }

        function initSingleDatePickers() {
            $('.date-picker-single').daterangepicker({
                singleDatePicker: true,
                showDropdowns: true,
                timePicker: true,
                timePicker24Hour: true,
                timePickerIncrement: 5,
                autoApply: true,
                autoUpdateInput: true,
                locale: {
                    format: dateRangePickerDateFormat,
                }
            });
        }

        let submitFilterBtn = $('#submitFilterBtn');

        $(submitFilterBtn).on('click', function (e) {
            e.preventDefault();
            submitToursFilterForm();
        });

        function submitToursFilterForm() {
            $(submitFilterBtn).prop('disabled', true);
            $.ajax({
                url: mainUrl + '/tour',
                type: "get",
                data: $('#tourFilterForm').serialize(),
                success: function (toursTableHtmlFragment) {
                    let toursTable = $('#toursTable');
                    $(toursTable).DataTable().destroy();
                    $(toursTable).html(toursTableHtmlFragment);
                    $(toursTable).DataTable({
                        columnDefs: [{
                            targets: 4,
                            render: function (data, type, row) {
                                return data.length > 80 ?
                                    data.substr(0, 80) + '…' :
                                    data;
                            }
                        }]
                    }).draw();
                    // initSingleDatePickers();
                    initEditTourButtons();

                    $(submitFilterBtn).prop('disabled', false);
                },
                error: function (responseData) {
                    console.error('unable to get tours table fragment ' + responseData.responseJSON.message);
                    Swal.fire({
                        icon: 'error',
                        title: 'unable to load tours ' + responseData.responseJSON.message
                    });
                    $(submitFilterBtn).prop('disabled', false);
                }
            });
        }

        function initEditTourButtons() {
            $('.tourEditBtn').on('click', function (e) {
                e.preventDefault();
                let btn = $(this);
                let tourId = $(btn).attr('data-tour-id');

                $(this).prop('disabled', true);
                $.ajax({
                    url: mainUrl + '/tour/' + tourId,
                    type: "get",
                    success: function (tourFormContent) {
                        if (tourFormContent) {
                            $(tourForm).html(tourFormContent);
                        }
                        $(btn).prop('disabled', false);
                        initTourFormButtons();
                        initSingleDatePickers();
                        $(tourFormContainer).collapse('show');
                    },
                    error: function (error) {
                        Swal.fire({
                            icon: 'error',
                            title: 'unable to load form to edit tour because' + error.responseJSON.message
                        });
                    }
                })
            });
        }

        function initTourFormButtons() {
            $('.tourDeleteFileBtn').on('click', function (e) {
                e.preventDefault();
                let btn = $(this);
                let tourId = $(btn).attr('data-tour-id');
                let fileName = $(btn).attr('data-tour-file-name');
                $(this).prop('disabled', true);
                $.ajax({
                    url: mainUrl + '/tour/' + tourId + '/file/'  + fileName,
                    type: "delete",
                    success: function (tourFormFilesTable) {
                        if (tourFormFilesTable) {
                            $('#uploadedFilesTable').html(tourFormFilesTable);
                        }
                        $(btn).prop('disabled', false);
                        initTourFormButtons();
                    },
                    error: function (error) {
                        Swal.fire({
                            icon: 'error',
                            title: 'unable to delete tour file because' + error.responseJSON.message
                        });
                        initTourFormButtons();
                    }
                })
            });
        }

        /*]]>*/
    </script>
</div>
</body>
</html>