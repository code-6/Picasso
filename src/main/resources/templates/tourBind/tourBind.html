<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">
<head>
    <title>Bind | PCS</title>

    <!-- Latest compiled and minified CSS -->
    <link th:href="@{/vendor/jsgantt-improved/dist/jsgantt.css}" rel="stylesheet" type="text/css"/>

    <link rel="stylesheet" type="text/css"
          th:href="@{/webjars/bootstrap-daterangepicker/css/bootstrap-daterangepicker.css}"/>

    <link rel="stylesheet" type="text/css"
          th:href="@{/webjars/bootstrap-select/dist/css/bootstrap-select.min.css}"/>

    <link th:href="@{/vendor/popover/css/bootstrap-popover-x.min.css}" rel="stylesheet">

    <style>
        .card-body {
            padding: 0 1rem 1rem;
        }

        .selectpicker {
            border: 1px solid #ccc !important;
            border-radius: 16px;
        }

        div.tour-select-identitfier-text {
            text-align: left;
        }

        div.tour-select-date-range-text {
            text-align: right;
        }
    </style>
</head>
<body class="sb-nav-fixed">

<!-- Page management components -->
<div th:fragment="pageManageComponents" class="mx-auto order-0">

    <div class="btn-toolbar" role="toolbar" aria-label="Toolbar with button groups">
        <div class="btn-group mr-2" role="group" aria-label="First group">
            <a class="nav-link" href="#tourBindFilter" data-target="#tourBindFilter" data-toggle="collapse" aria-controls="tourBindFilter"
               aria-expanded="false">
                <i class="fas fa-filter"></i>
                <span th:text="#{filter.cap.pl}"></span>
            </a>
        </div>

        <div class="btn-group mr-2" role="group" aria-label="Second group">
            <a class="nav-link" id="bindFormToggleBtn" data-toggle="collapse" data-target="#tourBind"
               aria-expanded="false" aria-controls="tourBind" href="#tourBind">
                <i id="tourFormToggleBtnIcon" class="fas fa-eye"></i>
                <span th:text="#{tourFormToggleBtn}"></span>
            </a>
        </div>
    </div>
</div>

<div layout:fragment="content">

    <div class="row">
        <div class="col">
            <div class="collapse" id="tourBind">
                <div class="card w-auto">
                    <div class="card-header">Bind form</div>
                    <div class="card-body">
                        <form id="tourBindForm" th:object="${tourBind}" th:method="post" th:action="@{/}"
                              th:fragment="tourBindForm">
                            <div class="row form-group">
                                <div class="col-sm-2">
                                    <label for="bindFormTourSelect" th:text="#{tour.cap}"></label>
                                </div>
                                <div class="col">
                                    <select id="bindFormTourSelect"
                                            class="form-control selectpicker tourSelect show-tick"
                                            required
                                            data-live-search="true" data-selected-text-format="count > 1"
                                            th:field="*{tour}" name="tour">
                                        <option th:value="${null}"></option>
                                        <option th:each="tour : ${allTours}"
                                                th:value="${tour.id}"
                                                th:text="${tour.id + ': ' + tour.name}"
                                                th:data-subtext="${tour.getDateRange()}"
                                                th:selected="${tourBind.tour.id == tour.id}">
                                        </option>
                                    </select>
                                </div>
                                <div class="col-sm-1">
                                    <!--                                    <button class="btn btn-outline-success"-->
                                    <!--                                            th:title="#{tour.no-required-entry}"-->
                                    <!--                                            data-toggle="collapse" href="#tourFormContainer" type="button"-->
                                    <!--                                            aria-expanded="false" aria-controls="tourFormContainer">-->
                                    <!--                                        <i class="fa-solid fa-plus"></i>-->
                                    <!--                                    </button>-->
                                </div>
                            </div>

                            <div class="collapse" id="bindResultTourDetails">

                                <div class="row form-group">
                                    <div class="col-sm-2">
                                        <label for="bindResultTourDates" th:text="#{date.cap.pl}"></label>
                                    </div>
                                    <div class="col">
                                        <input id="bindResultTourDates" class="form-control" readonly
                                               th:value="${tourBind.tour?.getDateRange()?.toString()}">
                                    </div>
                                    <div class="col-sm-1"></div>
                                </div>
                                <div class="row form-group">
                                    <div class="col-sm-2">
                                        <label for="bindResultTourDescription" th:text="#{description.cap}"></label>
                                    </div>
                                    <div class="col">
                                        <textarea id="bindResultTourDescription" class="form-control" readonly
                                                  th:text="${tourBind.tour.description}"></textarea>
                                    </div>
                                    <div class="col-sm-1"></div>
                                </div>

                            </div>

                            <div id="bindResultEmployees" th:fragment="bindResultEmployees">
                                <div class="employee-bind-row" th:each="employeeBind, employeeBindRow : ${tourBind.employees}">
                                    <div class="row form-group">
                                        <div class="col-sm-2">
                                            <select th:id="${'employeeTypeSelect_' + employeeBindRow.index}"
                                                    class="form-control selectpicker employeeTypeSelect employeeTypeSelect-bindForm"
                                                    data-live-search="true" required
                                                    th:field="${tourBind.employees[__${employeeBindRow.index}__].employee.type}"
                                                    th:data-employee-select-id="${'employeeSelect_' + employeeBindRow.index}">
                                                <option th:value="${null}"></option>
                                                <option th:each="employeeType : ${allEmployeeTypes}"
                                                        th:value="${employeeType}"
                                                        th:text="${employeeType.name()}"
                                                        th:selected="${employeeBind.employee != null and employeeBind.employee.type != null and employeeBind.employee.type.equals(employeeType)}">
                                                </option>
                                            </select>
                                        </div>
                                        <div class="col">
                                            <select th:id="${'employeeSelect_' + employeeBindRow.index}"
                                                    class="form-control selectpicker employeeSelect employeeSelect-bindForm"
                                                    required
                                                    data-live-search="true"
                                                    th:field="${tourBind.employees[__${employeeBindRow.index}__].employee}">
                                                <option th:value="${null}"></option>
                                                <option th:each="employee : ${@employeeService.getOrEmpty(employeeBind.employee?.type)}"
                                                        th:value="${employee.id}"
                                                        th:text="${employee.id + '. ' + employee.name}"
                                                        th:data-subtext="${employee.type.name()}"
                                                        th:selected="${employeeBind.employee != null and employeeBind.employee.equals(employee)}">
                                            </select>
                                        </div>
                                        <div class="col-sm-1">
                                            <!--                                            TODO 2022-08-15 enabled only if employee type and employee selected. Also allow to add more only if previously added date-range filled. Disallow to submit if any of date-ranges is empty.-->
                                            <button class="btn btn-outline-success bindEmployeeDateRangeBtn" type="button"
                                                    th:data-employee-row-id="${employeeBindRow.index}"
                                                    data-ctx="bindEmployeeDateRange"
                                                    title="Add custom date range. Optional action, if not chosen, employee will be utilized to full tour date range">
                                                <i class="fa-solid fa-calendar-plus"></i>
                                            </button>
                                        </div>
                                        <div class="col-sm-1">
                                            <button class="btn btn-outline-primary unbindEmployeeBtn" type="button"
                                                    title="Unbind employee"
                                                    th:data-employee-row-id="${employeeBindRow.index}">
                                                <i class="fa-solid fa-user-xmark"></i>
                                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none"></span>
                                            </button>
                                        </div>
                                        <div class="col-sm-1"></div>
                                    </div>
                                    <div th:each="employeeDateRange, employeeDateRangeRow : ${employeeBind.getBindIdsToDateRanges}">
                                        <div class="row form-group">
                                            <div class="col-sm-2"></div>
                                            <div class="col">
                                                <input type="hidden" name="bindId"
                                                       th:field="${tourBind.employees[__${employeeBindRow.index}__].bindIdsToDateRanges[__${employeeDateRangeRow.index}__]?.bindId}">

                                                <input type="text" required
                                                       class="form-control date-picker date-picker-employee-tour-bind"
                                                       th:id="${'employeeTourDateRange_'+employeeBindRow.index+'-'+employeeDateRangeRow.index}"
                                                       th:data-employee-id="${employeeBind?.employee?.id}"
                                                       th:data-tour-id="${tourBind.tour.id}" name="dateRange"
                                                       th:field="${tourBind.employees[__${employeeBindRow.index}__].bindIdsToDateRanges[__${employeeDateRangeRow.index}__]?.dateRange}"
                                                       th:value="${tourBind.employees[__${employeeBindRow.index}__].bindIdsToDateRanges[__${employeeDateRangeRow.index}__]?.dateRange.toString()}">
                                            </div>
                                            <div class="col-sm-1">
                                                <button class="btn btn-outline-primary unbindEmployeeDateRangeBtn" type="button"
                                                        th:data-employee-date-range-row-id="${employeeDateRangeRow.index}"
                                                        th:data-employee-row-id="${employeeBindRow.index}"
                                                        title="Remove custom date range"
                                                        data-ctx="unbindEmployeeDateRange">
                                                    <i class="fa-solid fa-calendar-xmark"></i>
                                                </button>
                                            </div>
                                            <div class="col-sm-1"></div>
                                            <div class="col-sm-1"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="collapse" id="bindResultEmployeesControls">
                                <div class="row form-group">
                                    <div class="col-sm-2"></div>
                                    <div class="col">
                                        <button class="btn btn-outline-success btn-block" type="button"
                                                id="bindEmployeeBtn"
                                                th:text="#{bind-employee-to-the} + ${tourBind.tour?.name}">
                                        </button>
                                    </div>
                                    <div class="col-sm-1">
                                        <!--                                        <button class="btn btn-outline-success" type="button"-->
                                        <!--                                                title="These aren't the employees you're looking for ? Create new one. ">-->
                                        <!--                                            <i class="fa-solid fa-plus"></i>-->
                                        <!--                                        </button>-->
                                    </div>
                                </div>
                            </div>

                            <div class="row form-group collapse" id="submitBindBtnRow">
                                <div class="col-sm-2"></div>
                                <div class="col">
                                    <!--                                    TODO 2022-08-15 : allow to submit only if: -->
                                    <!--                                    1) Tour is chosen-->
                                    <!--                                    2) At least one employee chosen-->
                                    <!--                                    3) There is no overlaps with other tours-->
                                    <button class="btn btn-outline-success btn-block" type="submit" id="submitBindBtn"
                                            th:text="#{submit.cap}">
                                    </button>
                                </div>
                                <div class="col">
                                    <button class="btn btn-outline-warning btn-block" id="resetBindFormBtn"
                                            type="button"
                                            th:title="#{clear.title}">Reset
                                    </button>
                                </div>
                                <div class="col-sm-1"></div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!--            tour bind filter form (filter gantt chart)-->
    <div class="row">
        <div class="col">
            <div class="collapse show" id="tourBindFilter">
                <div class="card">
                    <div class="card-header">Gantt chart filter form</div>
                    <div class="card-body">
                        <form th:object="${tourBindFilter}" th:id="tourBindFilterForm" th:fragment="tourBindFilterForm">
                            <div class="row g-2 align-items-end" th:include="tourBind/tourBindFilterForm :: tourBindFilterFormContent"></div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col">
            <div class="collapse show">
                <div class="card w-auto">
                    <div class="card-header">Gantt chart</div>
                    <div class="card-body">
                        <div style="position:relative; padding-top: 1rem;" class="gantt" id="GanttChartDIV"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
<!--all page related scripts should be wrapped into 'scripts' thymeleaf fragment-->
<div th:fragment="scripts">

    <script th:src="@{/vendor/jsgantt-improved/dist/jsgantt.js}" type="text/javascript"></script>

    <script type="text/javascript" th:src="@{/webjars/momentjs/moment.js}"></script>

    <script type="text/javascript"
            th:src="@{/webjars/bootstrap-daterangepicker/js/bootstrap-daterangepicker.js}"></script>

    <script type="text/javascript" th:src="@{/webjars/bootstrap-select/dist/js/bootstrap-select.js}"></script>

    <script th:src="@{/vendor/popover/js/bootstrap-popover-x.min.js}"></script>

    <script type="module" th:inline="javascript">
        import * as ajaxUtil from "./js/AjaxUtil.js";
        import {FragmentSubject} from "./js/Observer.js";

        // main url stored in head tag of layout.html
        const mainUrl = $("meta[name='mainUrl']").attr("content");

        const userLanguage = $("meta[name='userLanguage']").attr('content');

        const dateRangePickerDateFormat = $("meta[name='dateRangePickerDateFormat']").attr('content');
        const ganttTaskDateFormat = $("meta[name='ganttTaskDateFormat']").attr('content');
        const ganttMajorDateFormat = $("meta[name='ganttMajorDateFormat']").attr('content');

        /**
         * When bind form employees fragment updated notify related observers.
         * */
        const bindFormEmployeesFragmentSubject = new FragmentSubject()
            .subscribe(initEmployeeTypeSelectChangeListener)
            .subscribe(initBindFormDatePickers)
            .subscribe(refreshBootstrapSelects)
            .subscribe(initUnbindEmployeeButtons)
            .subscribe(initBindEmployeeDateRangeButtons)
            .subscribe(initEmployeeSelectChangeListener)
            .subscribe(initUnbindEmployeeDateRangeButtons);

        const bindFormFragmentSubject = new FragmentSubject()
            .subscribe(initBindEmployeeButton)
            .subscribe(initBindFormTourSelect)
            .subscribe(initBindFormResetButton)
            .subscribe(initBindFormSubmitButton);

        moment.locale(userLanguage); // to fix different locale issue in date-range picker

        $(document).ready(function () {

            initSingleDatePickers();

            initFilterDates();

            initFilterSubmitButton();

            bindFormEmployeesFragmentSubject.notifyObservers();

            bindFormFragmentSubject.notifyObservers();

            initGanttChart();

            // onEditEntityButton();

            $('#tourBind').on('show.bs.collapse', function () {
                const selectedTourId = $('#bindFormTourSelect').find(":selected").map((_, e) => e.value).get();

                if (selectedTourId == null || selectedTourId[0] === '') {
                    changeEmployeeBindFormCollapseElementsVisibility();
                    initBindFormTourDetails();
                    $('#resetBindFormBtn').prop('disabled', true)
                } else {
                    $('#resetBindFormBtn').prop('disabled', false)
                }
            })
        });

        /**
         * Get tour binds as gantt chart task from server and reinitialize (redraw) gantt chart
         * */
        function initFilterSubmitButton() {
            $('#submitFilterBtn').on('click', function (e) {
                e.preventDefault();

                $(this).prop('disabled', true);

                let url = mainUrl + '/api/bind/gantt-tasks';
                let formData = $('#tourBindFilterForm').serialize();

                ajaxUtil.post(url, formData)
                    .then((ganttTasks) => {
                        initGanttChart(ganttTasks);
                    })
                    .catch((error) => {
                        console.error('unable to load tour binds for Gantt chart from server %s', error.responseJSON.message);
                        Swal.fire({
                            icon: 'error',
                            title: 'unable to load tour binds for Gantt chart from server'
                        });
                    })
                    .finally($(this).prop('disabled', false));
            });
        }

        /**
         * Initialize bootstrap single date range pickers
         * */
        function initSingleDatePickers() {
            $('.date-picker-single').daterangepicker({
                singleDatePicker: true,
                showDropdowns: true,
                timePicker: true,
                timePicker24Hour: true,
                timePickerIncrement: 5,
                autoApply: true,
                autoUpdateInput: true,
                locale: {
                    format: dateRangePickerDateFormat,
                }
            });
        }

        /**
         * Initialize bootstrap date range pickers with min and max dates to choose. Min = tour start date, max = tour end date.
         * When date range is chosen then cal API to validate and check if chosen date range overlaps with other tours.
         *
         * @param tour tour object (JSON data). If undefined then will be used selected tour in bind form.
         * */
        function initBindFormDatePickers(tour) {
            let tourStartDate = null;
            let tourEndDate = null;
            try {
                // if tour not provided use selected tour
                if (!tour) {
                    const chosenTourId = $('#bindFormTourSelect').find(":selected").map((_, e) => e.value).get();
                    if (chosenTourId != null && chosenTourId[0] !== '') {
                        tour = ajaxUtil.getSync(mainUrl + '/api/tour/' + chosenTourId)
                    }
                }
                if (tour) {
                    tourStartDate = new Date(tour.startDate);
                    tourEndDate = new Date(tour.endDate);
                }
            } catch (e) {
                console.error(e);
            }
            $('.date-picker-employee-tour-bind').daterangepicker({
                showDropdowns: true,
                timePicker: true,
                timePicker24Hour: true,
                timePickerIncrement: 5,
                minDate: tourStartDate,
                maxDate: tourEndDate,
                autoApply: true,
                autoUpdateInput: true,
                locale: {
                    separator: ' ~ ',
                    format: dateRangePickerDateFormat,
                }
            }).on('apply.daterangepicker hideCalendar.daterangepicker hide.daterangepicker', function (e, clickedIndex, isSelected, previousValue) {
                // validate bind when employee dates changed
                let datePickerInputField = $(this);
                let employeeId = $(this).attr('data-employee-id');
                // in case if date-picker doesn't contains attribute data-employee-id try to search for value different way
                if (!employeeId) {
                    // search for employee select related to this date-picker by id
                    // each date picker id has following format employeeTourDateRange_{employeeRowId}-{datePickerRowId} example employeeTourDateRange_0-0
                    // first number after employeeTourDateRange_ indicates to wich employee select its related.
                    let datePickerId = $(this).attr('id');

                    // extract first number after _
                    let employeeSelectRowIndex = datePickerId.match(/_\d/)[0].substring(1);

                    // find required employeeSelect and extract selected option value which contains employee id
                    let employeeSelect = $('#' + 'employeeSelect_' + employeeSelectRowIndex).find(":selected").map((_, e) => e.value).get();

                    if (employeeSelect && employeeSelect[0] && employeeSelect[0] !== '') {
                        employeeId = employeeSelect[0];
                    }
                }
                if (employeeId) {

                    let tourId = $(this).attr('data-tour-id');
                    let dateRange = $(this).val();
                    ajaxUtil.get(mainUrl + '/api/bind/validate/' + tourId + '/' + employeeId + '/' + dateRange)
                        .then(() => {
                            if ($(datePickerInputField).hasClass('is-invalid'))
                                $(datePickerInputField).removeClass('is-invalid')
                            enableSubmitBindFormButton();
                        })
                        .catch((error) => {
                            if(error.status === 409) {
                                $(datePickerInputField).addClass('is-invalid')
                                disableSubmitBindFormButton();
                            }
                            Swal.fire({
                                icon: 'error',
                                title: error.responseText
                            });
                        });
                }
            });
        }

        /**
         * When employee type select value is chosen then load employees from backend and initialize employee selects.
         * */
        function initEmployeeTypeSelectChangeListener() {
            $('.employeeTypeSelect').each(function () {
                $(this).on('changed.bs.select', function () {
                    loadEmployeesForSelect($(this));
                });
            });
        }

        /**
         * Get list of employees from backend and initialize employee selects.
         * */
        function loadEmployeesForSelect($employeeTypeSelect) {

            const chosenEmployeeTypes = $employeeTypeSelect.find(":selected").map((_, e) => e.value).get();

            const employeeSelectId = '#' + $employeeTypeSelect.attr('data-employee-select-id');

            let $employeeSelect = $(employeeSelectId);

            $employeeSelect.empty();

            let getEmployeesByTypesApiUrl = mainUrl + "/api/employee";

            let payloadData = {
                "types": chosenEmployeeTypes.toString().replace('[', '').replace(']', '')
            };

            ajaxUtil.get(getEmployeesByTypesApiUrl, payloadData)
                .then((employees) => {
                    let emptyOption = new Option('', null);
                    $employeeSelect.append(emptyOption);
                    $.each(employees, function (index, employee) {
                        // add options to select
                        let option = new Option(employee.id + '. ' + employee.name, employee.id);
                        option.setAttribute('data-subtext', employee.type);
                        $employeeSelect.append(option);
                    });
                    $employeeSelect.prop("disabled", false);
                    $employeeSelect.selectpicker('refresh')
                    // automatically open related employee select when employee type select value chosen
                    $employeeSelect.selectpicker('toggle');
                })
                .catch((error) => {
                    console.error('unable to get employees of type %s from backend %s', chosenEmployeeTypes, error.responseJSON.message)
                    $employeeSelect.prop("disabled", true);
                    Swal.fire({
                        icon: 'error',
                        title: 'unable to load employees'
                    });
                });
        }

        /**
         * @param {'show' | 'hide'} visibility - The action to perform. Default value = 'hide'
         */
        function changeEmployeeBindFormCollapseElementsVisibility(visibility = 'hide') {
            $('#bindResultTourDetails').collapse(visibility);
            $('#bindResultEmployees').collapse(visibility);
            $('#bindResultEmployeesControls').collapse(visibility);
            $('#submitBindBtnRow').collapse(visibility);
        }

        function initBindFormTourDetails(tour = null) {

            let $bindResultTourName = $('#bindResultTourName');
            let $bindResultTourDates = $('#bindResultTourDates');
            let $bindResultTourDescription = $('#bindResultTourDescription');

            if(!tour) {
                $bindResultTourName.val(null);
                $bindResultTourDates.val(null);
                $bindResultTourDescription.val(null);
            } else {
                let tourStartDate = new Date(tour.startDate);
                let tourEndDate = new Date(tour.endDate);
                let tourDateRange = moment(tourStartDate).format(dateRangePickerDateFormat) + ' ~ ' + moment(tourEndDate).format(dateRangePickerDateFormat);

                $bindResultTourName.val(tour.name);
                $bindResultTourDates.val(tourDateRange);
                $bindResultTourDescription.val(tour.description);
            }
        }

        /**
         * When tour is selected in bind form then:
         * 1. check value if tour == null then hide other form components else load tour from backend and fill tour details.
         * 2. reinitialize date pickers.
         * */
        function initBindFormTourSelect() {
            // when tour is changed in bind form then load tour details like dates and description and update form. Also show/hide other components.
            $('#bindFormTourSelect').on('changed.bs.select', function (e, clickedIndex, isSelected, previousValue) {
                const selectedTourId = $(this).find(":selected").map((_, e) => e.value).get();
                let $resetBindFormBtn = $('#resetBindFormBtn');
                if (selectedTourId == null || selectedTourId[0] === '') {
                    changeEmployeeBindFormCollapseElementsVisibility();
                    initBindFormTourDetails();
                    $resetBindFormBtn.prop('disabled', true);
                } else {
                    let url = mainUrl + '/api/tour/' + selectedTourId;
                    ajaxUtil.get(url)
                        .then((tour) => {
                            initBindFormTourDetails(tour);
                            $resetBindFormBtn.prop('disabled', false);
                            $('#bindEmployeeBtn').text('Add employee to the ' + tour.name);
                            changeEmployeeBindFormCollapseElementsVisibility('show');
                        })
                        .catch((error) => {
                            console.error('unable to load tour with id %d %s', selectedTourId, error.responseJSON.message);
                            initBindFormTourDetails();
                            changeEmployeeBindFormCollapseElementsVisibility();
                            Swal.fire({
                                icon: 'error',
                                title: 'unable to get tour by id: ' + selectedTourId
                            });
                        });
                }
            });
        }

        /**
         * When user selected first time employee A and selected date ranges then changed employee validate bind for new employee should be called again.
         * */
        function initEmployeeSelectChangeListener() {
            $('.employeeSelect-bindForm').on('changed.bs.select', function (e, clickedIndex, isSelected, previousValue) {
                let selectedTourId = $('#bindFormTourSelect').find(":selected").map((_, e) => e.value).get();

                if (selectedTourId && selectedTourId[0] && selectedTourId[0] !== '') {
                    selectedTourId = selectedTourId[0];

                    let employeeId = $(this).find(":selected").map((_, e) => e.value).get();

                    $(this).closest('div.employee-bind-row').find('.date-picker-employee-tour-bind').each(function (index, dateRangeInput) {
                        let dateRange = $(dateRangeInput).val();
                        ajaxUtil.get(mainUrl + '/api/bind/validate/' + selectedTourId + '/' + employeeId + '/' + dateRange)
                            .then(() => {
                                if ($(dateRangeInput).hasClass('is-invalid'))
                                    $(dateRangeInput).removeClass('is-invalid')

                                enableSubmitBindFormButton();
                            }).catch((error) => {
                                if(error.status === 409) {
                                    $(dateRangeInput).addClass('is-invalid')
                                    disableSubmitBindFormButton();
                                }
                                Swal.fire({
                                    icon: 'error',
                                    title: error.responseText
                                });
                            });
                    })
                }
            });
        }

        function initBindFormSubmitButton() {
            $('#tourBindForm').submit(function (event) {
                event.preventDefault();

                $(this).unbind('submit').submit();

            });
        }

        function initBindFormResetButton() {
            $('#resetBindFormBtn').on('click', function () {
                ajaxUtil.get(mainUrl + '/-1').then((bindFormFragment) => {
                    $('#tourBindForm').html(bindFormFragment);
                    $('#tourBind').collapse('show');
                    bindFormFragmentSubject.notifyObservers();
                    bindFormEmployeesFragmentSubject.notifyObservers();
                }).catch((error) => {
                    console.error('initBindFormResetButton unable to load bind form fragment %s', error.responseJSON.message);
                    Swal.fire({
                        icon: 'error',
                        title: 'unable to open bind form for edit'
                    });
                })
            })
        }

        function hideTooltips() {
            $('.JSGanttToolTipcont').attr('showing', null)
            let tooltip = $('.JSGanttToolTip');
            $(tooltip).css('visibility', 'hidden')
            $(tooltip).css('opacity', '0')
            $(tooltip).css('filter', 'alpha(opacity=0)')
        }

        function initEditBindButtons() {
            $('.btn-edit-entity').addEventListener('click', onEditEntityButton)
        }

        // event handler when bind, tour or employee edit button pressed.
        window.onEditEntityButton=(ctx, entityId) => {

            if (ctx === '/') ctx = "";

            ajaxUtil.get(mainUrl + ctx + '/' + entityId)
                .then((bindFormFragment) => {
                    $('#tourBindForm').html(bindFormFragment);
                    $('#tourBind').collapse('show');
                    changeEmployeeBindFormCollapseElementsVisibility('show');
                    bindFormFragmentSubject.notifyObservers();
                    bindFormEmployeesFragmentSubject.notifyObservers();
                })
                .catch((error) => {
                    console.error('initEditEntityButton unable to load bind form fragment for edit bind %s', error.responseJSON.message);
                    Swal.fire({
                        icon: 'error',
                        title: 'Unable to open bind form for edit'
                    });
                })
                .finally(() => {
                    $(this).prop('disabled', false);
                    hideTooltips();
                });
        }

        function initBindEmployeeButton() {
            $('#bindEmployeeBtn').on('click', function(e) {
                e.preventDefault();
                $(this).prop('disabled', true);
                updateBindResultEmployeesFragment(mainUrl + '/bindEmployee')
                    .finally($(this).prop('disabled', false));
            });
        }

        function initUnbindEmployeeButtons() {
            $('.unbindEmployeeBtn').on('click', function(e){
                toggleSpinner($(this));
                let employeeRowId = $(this).attr('data-employee-row-id');
                let url = mainUrl + '/unbindEmployee/' + employeeRowId;
                updateBindResultEmployeesFragment(url).finally(() => toggleSpinner($(this)));
            });
        }

        function initBindEmployeeDateRangeButtons() {
            $('.bindEmployeeDateRangeBtn').on('click', function(e){
                e.preventDefault();
                let employeeRowId = $(this).attr('data-employee-row-id');

                let url = mainUrl + '/bindEmployeeDateRange/' + employeeRowId;
                updateBindResultEmployeesFragment(url);
            });
        }

        function initUnbindEmployeeDateRangeButtons() {

            $('.unbindEmployeeDateRangeBtn').on('click', function(e){
                e.preventDefault();
                let employeeRowId = $(this).attr('data-employee-row-id');
                let dateRangeRowId = $(this).attr('data-employee-date-range-row-id');
                let url = mainUrl + '/unbindEmployeeDateRange/' + employeeRowId + '/' + dateRangeRowId;
                updateBindResultEmployeesFragment(url);
            });
        }

        function disableSubmitBindFormButton() {
            $('#submitBindBtn').prop('disabled', true);
        }

        function enableSubmitBindFormButton() {
            $('#submitBindBtn').prop('disabled', false);
        }

        function refreshBootstrapSelects() {
            $('.employeeTypeSelect').selectpicker('refresh');
            $('.employeeSelect').selectpicker('refresh');
            $('.tourSelect').selectpicker('refresh');
        }

        function initFilterDates() {
            let defaultStartDate = new Date([[${tourBindFilter.getStartDateAsString()}]].toString());
            let defaultEndDate = new Date([[${tourBindFilter.getEndDateAsString()}]].toString());

            $('#filterStartDate').data('daterangepicker').setStartDate(defaultStartDate);
            $('#filterEndDate').data('daterangepicker').setStartDate(defaultEndDate);
        }

        function initGanttChart(ganttTasks) {

            if (!ganttTasks)
                ganttTasks = [[${toursForGantt}]];

            let ganttChart = new JSGantt.GanttChart(document.getElementById('GanttChartDIV'), 'day');

            // configure ganttChart columns
            ganttChart.setShowRes(0);
            ganttChart.setShowDur(0);
            ganttChart.setShowComp(0);
            ganttChart.setShowStartDate(0);
            ganttChart.setShowEndDate(0);
            ganttChart.setShowPlanStartDate(0);
            ganttChart.setShowPlanEndDate(0);
            ganttChart.setShowCost(0);
            ganttChart.setShowDeps(0);

            // add vertical scroll
            ganttChart.setTotalHeight('300px')

            // configure ganttChart date columns width
            ganttChart.setDayColWidth(22);

            // configure ganttChart date format displayed on top and bottom of the table
            ganttChart.setDayMajorDateDisplayFormat(ganttMajorDateFormat);
            ganttChart.setDateTaskTableDisplayFormat(ganttTaskDateFormat);
            ganttChart.setDateTaskDisplayFormat(ganttTaskDateFormat);

            // configure ganttChart tooltip information
            ganttChart.setShowTaskInfoRes(0)
            ganttChart.setShowTaskInfoLink(0)

            // add data to chart
            $.each(ganttTasks, function (index, data) {
                ganttChart.AddTaskItemObject(data);
            });

            ganttChart.setTotalHeight(document.documentElement.clientWidth);

            ganttChart.setTooltipTemplate(function (task) {
                let tooltipHtml;
                $.ajax({
                    url: mainUrl + '/ganttTooltipFragment?taskId=' + task.getDataObject().pID,
                    type: "get",
                    async: false,
                    success: function (responsePayload) {
                        console.log('get tooltip fragment success ')
                        tooltipHtml = responsePayload;
                    },
                    error: function (responsePayload) {
                        console.log('get tooltip fragment failed ' + responsePayload)
                        Swal.fire({
                            icon: 'error',
                            title: responsePayload
                        });
                    }
                });
                return tooltipHtml;
            });

            ganttChart.Draw();
        }

        function updateBindResultEmployeesFragment(url) {
            return ajaxUtil.post(url, $('#tourBindForm').serialize())
                .then((bindResultEmployeesFragment) => {
                    $('#bindResultEmployees').html(bindResultEmployeesFragment);
                    bindFormEmployeesFragmentSubject.notifyObservers();
                })
                .catch((error) => {
                    console.error('updateBindResultEmployeesFragment unable to load tourBind/tourBind :: bindResultEmployees fragment %s', error.responseJSON.message);
                    Swal.fire({
                        icon: 'error',
                        title: 'Unable add new row for bind employee date range.'
                    });
                });
        }
    </script>
</div>
</body>
</html>