<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">
<head>
    <meta charset="UTF-8">
    <title>PCS</title>

    <!-- Latest compiled and minified CSS -->
    <link th:href="@{/vendor/jsgantt-improved/dist/jsgantt.css}" rel="stylesheet" type="text/css"/>

    <link rel="stylesheet" type="text/css"
          th:href="@{/webjars/bootstrap-daterangepicker/css/bootstrap-daterangepicker.css}"/>

    <link rel="stylesheet" type="text/css" th:href="@{/webjars/bootstrap-select/dist/css/bootstrap-select.min.css}"/>

    <style>
        .card-body {
            padding: 0 1rem 1rem;
        }

        .selectpicker {
            border: 1px solid #ccc !important;
            border-radius: 16px;
        }
    </style>
</head>
<body class="sb-nav-fixed">

<div layout:fragment="content">
    <div class="card mb-4">
        <div class="card-header">
            <div class="row gx-5">
                <div class="col">
                    <i class="fas fa-table me-1"></i>
                    Gantt chart
                    <a class="btn btn-sm btn-link" data-toggle="collapse" href="#tourBindFilter" role="button"
                       aria-expanded="false" aria-controls="tourBindFilter tourBind tourFormContainer">
                        Filters
                    </a>
                    <a class="btn btn-sm btn-link" data-toggle="collapse" href="#tourBind" role="button"
                       aria-expanded="false" aria-controls="tourBind tourBindFilter tourFormContainer">
                        Create new bind
                    </a>
                </div>
            </div>
        </div>
        <div class="card-body">

            <!--            tour bind filter form (filter gantt chart)-->
            <div class="collapse" th:classappend="${tourBindFilter.hideFilterForm} ? '' : 'show'" id="tourBindFilter">
                <form th:object="${tourBindFilter}" th:action="@{/}" th:method="get">
                    <div class="row g-2">

                        <div class="col-md align-items-end">
                            <label for="filterStartDate">Start date</label>
                            <input type="text" class="form-control date-picker" id="filterStartDate"
                                   th:field="*{startDate}" name="startDate">
                        </div>

                        <div class="col-md align-items-end">
                            <label for="filterEndDate">End date</label>
                            <input type="text" class="form-control date-picker" id="filterEndDate"
                                   th:field="*{endDate}" name="endDate">
                        </div>

                        <div class="col-md align-items-end">
                            <label for="filterTourSelect">Tour</label>
                            <select id="filterTourSelect" class="form-control selectpicker tourSelect"
                                    th:field="*{tourIds}" multiple
                                    data-live-search="true" data-selected-text-format="count > 1" name="tourIds">
                                <option th:each="tour : ${allTours}"
                                        th:value="${tour.id}"
                                        th:text="${tour.name}"
                                        th:selected="${tourBindFilter.tourIds.contains(tour.id)}">
                                </option>
                            </select>
                        </div>

                        <div class="col-md align-items-end">
                            <label for="filterEmployeeTypeSelect">Employee type</label>
                            <select id="filterEmployeeTypeSelect" class="form-control selectpicker employeeTypeSelect"
                                    th:field="*{employeeTypes}"
                                    multiple data-live-search="true" data-selected-text-format="count > 3"
                                    name="employeeTypes"
                                    data-employee-select-id="filterEmployeeSelect">
                                <option th:each="employeeType : ${employeeTypes}"
                                        th:value="${employeeType}"
                                        th:text="${employeeType.name()}"
                                        th:selected="${tourBindFilter.employeeTypes.contains(employeeType)}">
                                </option>
                            </select>
                        </div>

                        <div class="col-md align-items-end">
                            <label for="filterEmployeeSelect">Employee</label>
                            <select id="filterEmployeeSelect" class="form-control selectpicker employeeSelect"
                                    th:field="*{employeeIds}"
                                    multiple data-live-search="true" data-selected-text-format="count > 2"
                                    name="employeeIds">
                            </select>
                        </div>

                        <div class="col-md align-items-end">
                            <label for="submitFilterBtn"> </label>
                            <button id="submitFilterBtn" type="submit"
                                    class="btn btn-outline-success btn-block form-control">Apply
                            </button>
                        </div>

                        <input type="hidden" name="hideFilterForm" value="false">
                    </div>
                </form>
            </div>

            <div class="row">

                <!--                tour bind form -->
                <div class="col collapse" th:classappend="${tourBindFormDTO.hideTourBindForm} ? '' : 'show'" id="tourBind"
                     th:if="${tourBindFormDTO != null}">
                    <form id="tourBindForm" th:object="${tourBindFormDTO}">
                        <div class="row">
                            <div id="tourBindChoose" class="col">
                                <div class="form-group row align-items-end">
                                    <div class="col-10">
                                        <label for="bindFormTourSelect" class="col-sm-3 col-form-label">Tour</label>
                                        <select id="bindFormTourSelect" class="form-control selectpicker tourSelect"
                                                data-live-search="true" data-selected-text-format="count > 1" th:field="*{tour}" name="tour">
                                            <option th:value="${null}"></option>
                                            <option th:each="tour : ${allTours}"
                                                    th:value="${tour.id}"
                                                    th:text="${tour.name}"
                                                    th:selected="${tourBindFormDTO?.tour?.id == tour.id}">
                                            </option>
                                        </select>
                                    </div>

                                    <div class="col">
                                        <button class="btn btn-outline-success"
                                                title="These aren't the tours you're looking for ? Create new one. "
                                                data-toggle="collapse" href="#tourFormContainer" type="button"
                                                aria-expanded="false" aria-controls="tourFormContainer">
                                            <i class="fa-solid fa-plus"></i>
                                        </button>
                                    </div>

                                </div>

                                <div class="form-group row align-items-end">
                                    <div class="col-10">
                                        <label for="bindFormEmployeeTypeSelect" class="col-sm-3 col-form-label">Employee
                                            type</label>
                                        <select id="bindFormEmployeeTypeSelect"
                                                class="form-control selectpicker employeeTypeSelect"
                                                multiple data-live-search="true" data-selected-text-format="count > 3"
                                                data-employee-select-id="bindFormEmployeeSelect">
                                            <option th:each="employeeType : ${employeeTypes}"
                                                    th:value="${employeeType}"
                                                    th:text="${employeeType.name()}"
                                                    th:selected="${tourBindFilter.employeeTypes.contains(employeeType)}">
                                            </option>
                                        </select>
                                    </div>

                                    <div class="col"></div>
                                </div>

                                <div class="form-group row align-items-end">
                                    <div class="col-10">
                                        <label for="bindFormEmployeeSelect"
                                               class="col-sm-3 col-form-label">Employee</label>
                                        <select id="bindFormEmployeeSelect"
                                                class="form-control selectpicker employeeSelect"
                                                multiple data-live-search="true" data-selected-text-format="count > 2">
                                        </select>
                                    </div>

                                    <div class="col">
                                        <button class="btn btn-outline-success" type="button"
                                                title="These aren't the employees you're looking for ? Create new one. ">
                                            <i class="fa-solid fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="col collapse collapse-horizontal show" id="tourBindResult"
                                 th:if="${tourBindFormDTO != null}">
                                <div class="card mb-4" id="bindResultTourCard" th:attr="style=${tourBindFormDTO.tour == null ? 'display: none' : ''}">
                                    <div class="card-header">
                                        <p>Chosen tour details</p>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-group row">
                                            <label for="bindResultTourCardName" class="col-sm-2 col-form-label">Name</label>
                                            <div class="col-sm-10">
                                                <input disabled class="form-control" th:value="${tourBindFormDTO?.tour?.name}" id="bindResultTourCardName">
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <label for="bindResultTourCardDateRange" class="col-sm-2 col-form-label">Dates</label>
                                            <div class="col-sm-10">
                                                <input class="form-control"
                                                       th:value="${tourBindFormDTO?.tour?.getDateRange()?.toString()}" disabled id="bindResultTourCardDateRange">
                                            </div>
                                        </div>

                                        <div class="form-group row">
                                            <label for="bindResultTourCardDateRange" class="col-sm-2 col-form-label">Description</label>
                                            <div class="col-sm-10">
                                               <textarea class="form-control" th:value="${tourBindFormDTO?.tour?.description}"
                                                         disabled id="bindResultTourCardDescription" ></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="card mb-4" id="bindResultEmployeesCard">
                                    <div class="card-header">
                                        <p>Chosen employees</p>
                                    </div>
                                    <div class="card-body">

                                    </div>
                                </div>
                            </div>
                        </div>

                        <input type="hidden" name="hideTourBindForm" value="false">
                    </form>
                </div>

                <!--                tour form -->
                <div class="col collapse collapse-horizontal" id="tourFormContainer">
                    <form th:object="${tour}" id="tourForm">
                        <div th:include="tour/tourForm :: tourFormContent"></div>
                    </form>
                </div>
            </div>

            <div style="position:relative; padding-top: 1rem;" class="gantt" id="GanttChartDIV"></div>

        </div>
    </div>
</div>
<!--all page related scripts should be wrapped into 'scripts' thymeleaf fragment-->
<div th:fragment="scripts">

    <script th:src="@{/vendor/jsgantt-improved/dist/jsgantt.js}" type="text/javascript"></script>

    <script type="text/javascript" th:src="@{/webjars/momentjs/moment.js}"></script>

    <script type="text/javascript"
            th:src="@{/webjars/bootstrap-daterangepicker/js/bootstrap-daterangepicker.js}"></script>

    <script type="text/javascript" th:src="@{/webjars/bootstrap-select/dist/js/bootstrap-select.js}"></script>

    <script th:inline="javascript">

        const mainUrl = $("meta[name='mainUrl']").attr("content");

        const dateTimeFormat = 'DD.MMM.YYYY HH:mm';

        initGantt();

        initDatePicker();

        $('.employeeTypeSelect').each(function () {

            let $employeeTypeSelect = $(this);

            $employeeTypeSelect.on('changed.bs.select', function () {
                loadEmployeesForSelect($employeeTypeSelect);
            });
        });

        $('#bindFormTourSelect').on('changed.bs.select', function () {
            initializeTourCard();
        });

        function loadEmployeesForSelect($employeeTypeSelect) {

            const chosenEmployeeTypes = $employeeTypeSelect.find(":selected").map((_, e) => e.value).get();

            const employeeSelectId = '#' + $employeeTypeSelect.attr('data-employee-select-id');

            let $employeeSelect = $(employeeSelectId);

            $employeeSelect.empty();

            let getEmployeesByTypesApiUrl = mainUrl + "/api/employee";

            $.ajax({
                url: getEmployeesByTypesApiUrl,
                type: "get",
                data: {
                    "types": chosenEmployeeTypes.toString().replace('[', '').replace(']','')
                },
                success: function (employees) {
                    $.each(employees, function (index, employee) {
                        let employeeId = employee.id;

                        $employeeSelect.append(new Option(employee.type + ': ' + employee.name, employeeId));
                    });
                    $employeeSelect.prop("disabled", false);
                    $employeeSelect.selectpicker('refresh');
                    $employeeSelect.selectpicker('toggle');
                },
                error: function () {
                    Swal.fire({
                        icon: 'error',
                        title: 'unable to load employees for chosen types: ' + chosenEmployeeTypes
                    });
                    $employeeSelect.prop("disabled", true);
                    $employeeSelect.selectpicker('refresh');
                }
            });
        }

        function initDatePicker() {

            $('.date-picker').daterangepicker({
                singleDatePicker: true,
                showDropdowns: true,
                timePicker: true,
                timePicker24Hour: true,
                timePickerIncrement: 5,
                autoApply: true,
                autoUpdateInput: true,
                locale: {
                    format: dateTimeFormat,
                }
            });

            let defaultStartDate = new Date([[${tourBindFilter.startDate}]].toString());
            let defaultEndDate = new Date([[${tourBindFilter.endDate}]].toString());

            $('#filterStartDate').data('daterangepicker').setStartDate(defaultStartDate);
            $('#filterEndDate').data('daterangepicker').setStartDate(defaultEndDate);
        }

        function initGantt() {

            let ganttDataJsonArray = JSON.parse([[${ganttData}]].toString());

            let ganttChart = new JSGantt.GanttChart(document.getElementById('GanttChartDIV'), 'day');

            // configure ganttChart columns
            ganttChart.setShowRes(0);
            ganttChart.setShowDur(0);
            ganttChart.setShowComp(0);
            ganttChart.setShowStartDate(0);
            ganttChart.setShowEndDate(0);
            ganttChart.setShowPlanStartDate(0);
            ganttChart.setShowPlanEndDate(0);
            ganttChart.setShowCost(0);
            ganttChart.setShowDeps(0);

            // add vertical scroll
            ganttChart.setTotalHeight('300px')

            // configure ganttChart date columns width
            ganttChart.setDayColWidth(22);

            // configure ganttChart date format
            ganttChart.setDayMajorDateDisplayFormat('dd.mon.yyyy');
            ganttChart.setDateTaskTableDisplayFormat('dd.mon.yyyy');

            // configure ganttChart tooltip information
            ganttChart.setShowTaskInfoRes(0)

            // add data to chart
            $.each(ganttDataJsonArray, function (index, data) {
                ganttChart.AddTaskItemObject(data);
            });

            /*ganttChart.setEventClickRow(function (task) {
                alert(task);
            });*/

            ganttChart.setTotalHeight(document.documentElement.clientWidth);
            ganttChart.Draw();
        }

        function initializeTourCard() {
            const selectedTourId = $('#bindFormTourSelect').find(":selected").map((_, e) => e.value).get()
            let getTourUrl = mainUrl + "/api/tour/" + selectedTourId;

            $('#bindResultTourCard').removeAttr('style');

            // load tour details
            $.ajax({
                url: getTourUrl,
                type: "get",
                success: function (tour) {
                    console.log(tour);
                    let tourStartDate = new Date(tour.startDate);
                    let tourEndDate = new Date(tour.endDate);
                    $('#bindResultTourCardName').val(tour.name);
                    $('#bindResultTourCardDateRange').val(moment(tourStartDate).format(dateTimeFormat) + ' ~ ' + moment(tourEndDate).format(dateTimeFormat));
                    $('#bindResultTourCardDescription').val(tour.description);
                },
                error: function () {
                    Swal.fire({
                        icon: 'error',
                        title: 'unable to get tour by id: ' + selectedTourId
                    });
                }
            });
        }

    </script>
</div>
</body>
</html>